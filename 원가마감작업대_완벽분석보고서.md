# ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ ì™„ë²½ ë¶„ì„ ë³´ê³ ì„œ

## ğŸ“‹ ê°œìš”
**ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ (Purchase Cost Worklist)**ëŠ” ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ì„ ê´€ë¦¬í•˜ê³ , ì´ë¥¼ ì—°ê²°ëœ ì¶œê³ ì— ì›ê°€ë¡œ ë°°ë¶„í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### ë°ì´í„° íë¦„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ì˜ìˆ˜ì¦ ì—…ë¡œë“œ                                                â”‚
â”‚     â†“                                                           â”‚
â”‚  /api/receipt-upload â†’ ocr_docs ë²„í‚· â†’ cms_receipt_inbox INSERT  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ì¶œê³ ì—ì„œ ì˜ìˆ˜ì¦ ì„ íƒ                                         â”‚
â”‚     â†“                                                           â”‚
â”‚  shipments/page.tsx â†’ receiptUsageUpsertMutation               â”‚
â”‚  â†’ cms_receipt_usage INSERT (SHIPMENT_HEADER ì—°ê²°)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ (purchase_cost_worklist)                    â”‚
â”‚     â†“                                                           â”‚
â”‚  A. ì˜ìˆ˜ì¦ ì´ê¸ˆì•¡ ì…ë ¥ (KRW/CNY)                                 â”‚
â”‚     â†“ cms_fn_upsert_receipt_pricing_snapshot_v1                 â”‚
â”‚  B. cms_receipt_pricing_snapshot ì €ì¥                          â”‚
â”‚     â†“ cms_fn_apply_receipt_pricing_snapshot_v1                 â”‚
â”‚  C. ì—°ê²°ëœ ì¶œê³ ì— ì›ê°€ ë¹„ë¡€ ë°°ë¶„                                 â”‚
â”‚     â†“                                                           â”‚
â”‚  cms_shipment_line.purchase_unit_cost_krw ì—…ë°ì´íŠ¸               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸” ë° ì»¬ëŸ¼

### 1. cms_receipt_inbox (ì˜ìˆ˜ì¦ ì¸ë°•ìŠ¤)
**ëª©ì **: ì—…ë¡œë“œëœ ì˜ìˆ˜ì¦ íŒŒì¼ì˜ ë©”íƒ€ë°ì´í„° ì €ì¥

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| receipt_id | UUID PK | ì˜ìˆ˜ì¦ ê³ ìœ  ID |
| received_at | TIMESTAMPTZ | ìˆ˜ì‹ ì¼ì‹œ |
| source | TEXT | 'SCANNER' \| 'UPLOAD' \| 'N8N' \| 'ETC' |
| file_bucket | TEXT | 'ocr_docs' (Storage ë²„í‚·) |
| file_path | TEXT | íŒŒì¼ ê²½ë¡œ (YYYY/MM/DD/í•´ì‹œ.í™•ì¥ì) |
| file_sha256 | TEXT | íŒŒì¼ í•´ì‹œ (ì¤‘ë³µ ë°©ì§€) |
| file_size_bytes | BIGINT | íŒŒì¼ í¬ê¸° |
| mime_type | TEXT | 'application/pdf' \| 'image/jpeg' ë“± |
| vendor_party_id | UUID | ê³µê¸‰ì²˜ (cms_party ì°¸ì¡°) |
| issued_at | DATE | ë°œí–‰ì¼ |
| total_amount_krw | NUMERIC | ì´ê¸ˆì•¡ (KRW) |
| currency_code | TEXT | 'KRW' \| 'CNY' |
| status | ENUM | 'UPLOADED' â†’ 'LINKED' â†’ 'ARCHIVED' |
| memo | TEXT | ë©”ëª¨ |
| meta | JSONB | ì¶”ê°€ ë©”íƒ€ë°ì´í„° |
| created_at | TIMESTAMPTZ | ìƒì„±ì¼ |
| updated_at | TIMESTAMPTZ | ìˆ˜ì •ì¼ |

### 2. cms_receipt_usage (ì˜ìˆ˜ì¦ ì‚¬ìš© ë§í¬)
**ëª©ì **: ì˜ìˆ˜ì¦ì´ ì–´ë–¤ ì—”í‹°í‹°(ì¶œê³ /ì¬ê³ ì´ë™)ì™€ ì—°ê²°ëëŠ”ì§€ ì¶”ì 

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| receipt_id | UUID FK | ì˜ìˆ˜ì¦ ID (cms_receipt_inbox) |
| entity_type | TEXT | 'SHIPMENT_HEADER' \| 'SHIPMENT_LINE' \| 'INVENTORY_MOVE_HEADER' \| 'INVENTORY_MOVE_LINE' |
| entity_id | UUID | ì—”í‹°í‹° ID (TEXTë¡œ ì €ì¥) |
| note | TEXT | ë©”ëª¨ |
| used_at | TIMESTAMPTZ | ì—°ê²°ì¼ì‹œ |
| actor_person_id | UUID | ì‘ì—…ì ID |
| correlation_id | UUID | ì‘ì—… ì¶”ì  ID |

**PK**: (receipt_id, entity_type, entity_id)

### 3. cms_receipt_pricing_snapshot (ì˜ìˆ˜ì¦ ê°€ê²© ìŠ¤ëƒ…ìƒ·)
**ëª©ì **: ì›ê°€ë§ˆê° ì‹œ ì…ë ¥ëœ ê¸ˆì•¡ ì •ë³´ ì €ì¥ (í™˜ìœ¨, ë°°ë¶„ ë‚´ì—­ í¬í•¨)

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| receipt_id | UUID PK FK | ì˜ìˆ˜ì¦ ID |
| currency_code | TEXT | 'KRW' \| 'CNY' |
| total_amount | NUMERIC | ì…ë ¥ëœ ì´ê¸ˆì•¡ (ì›í™”) |
| weight_g | NUMERIC | ì¤‘ëŸ‰ |
| labor_basic | NUMERIC | ê¸°ë³¸ ê³µì„ |
| labor_other | NUMERIC | ê¸°íƒ€ ê³µì„ |
| total_amount_krw | NUMERIC | KRW í™˜ì‚° ì´ê¸ˆì•¡ |
| fx_rate_krw_per_unit | NUMERIC | í™˜ìœ¨ (CNYâ†’KRW) |
| fx_tick_id | UUID | ì ìš©ëœ ì‹œì„¸ ID |
| meta | JSONB | í™˜ìœ¨ ì •ë³´, correlation_id ë“± |
| applied_at | TIMESTAMPTZ | ì›ê°€ ì ìš©ì¼ì‹œ |
| applied_by | UUID | ì ìš©ì ID |
| allocation_json | JSONB | ì¶œê³ ë³„ ë°°ë¶„ ë‚´ì—­ |
| created_at | TIMESTAMPTZ | ìƒì„±ì¼ |
| updated_at | TIMESTAMPTZ | ìˆ˜ì •ì¼ |

### 4. cms_shipment_line (ì¶œê³  ë¼ì¸ - ì›ê°€ ì»¬ëŸ¼)
**ëª©ì **: ì¶œê³  ë¼ì¸ë³„ ì›ê°€ ì •ë³´ ì €ì¥

| ì»¬ëŸ¼ | íƒ€ì… | ì„¤ëª… |
|------|------|------|
| total_amount_cost_krw | NUMERIC | ë‚´ë¶€ ê³„ì‚° ì›ê°€ (ê³µì„+ì†Œì¬) |
| purchase_unit_cost_krw | NUMERIC | êµ¬ë§¤ ë‹¨ê°€ (ì˜ìˆ˜ì¦ ê¸°ë°˜) |
| purchase_total_cost_krw | NUMERIC | êµ¬ë§¤ ì´ì•¡ (ë‹¨ê°€ Ã— ìˆ˜ëŸ‰) |
| purchase_cost_status | ENUM | 'PROVISIONAL' \| 'ACTUAL' |
| purchase_cost_source | ENUM | 'NONE' \| 'MASTER' \| 'RECEIPT' \| 'MANUAL' |
| purchase_receipt_id | UUID | ì ìš©ëœ ì˜ìˆ˜ì¦ ID |
| purchase_cost_trace | JSONB | ì›ê°€ ì ìš© ì´ë ¥ |
| purchase_cost_finalized_at | TIMESTAMPTZ | ì›ê°€ í™•ì •ì¼ |
| purchase_cost_finalized_by | UUID | ì›ê°€ í™•ì •ì |

---

## ğŸ”§ í•µì‹¬ DB í•¨ìˆ˜

### 1. cms_fn_upsert_receipt_inbox_v1
**íŒŒì¼**: 20260129225200_cms_0242_receipt_cost_rpcs.sql (line 4-78)

**ëª©ì **: ì˜ìˆ˜ì¦ íŒŒì¼ ì—…ë¡œë“œ ì‹œ ì¸ë°•ìŠ¤ì— ë“±ë¡

**ë¡œì§**:
1. file_sha256ë¡œ ì¤‘ë³µ ì²´í¬ â†’ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
2. ì—†ìœ¼ë©´ (file_bucket, file_path) ê¸°ì¤€ UPSERT
3. status, memo ë“± ì—…ë°ì´íŠ¸

### 2. cms_fn_upsert_receipt_pricing_snapshot_v1
**íŒŒì¼**: 20260201004000_cms_0266_receipt_pricing_apply.sql (line 88-208)

**ëª©ì **: ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ì—ì„œ ì˜ìˆ˜ì¦ ê¸ˆì•¡ ì €ì¥

**ì…ë ¥ íŒŒë¼ë¯¸í„°**:
- p_receipt_id: ì˜ìˆ˜ì¦ ID
- p_currency_code: 'KRW' | 'CNY'
- p_total_amount: ì´ê¸ˆì•¡
- p_weight_g: ì¤‘ëŸ‰
- p_labor_basic: ê¸°ë³¸ ê³µì„
- p_labor_other: ê¸°íƒ€ ê³µì„

**ë¡œì§**:
1. CNYì¸ ê²½ìš°: cms_market_tickì—ì„œ SILVER_CN_KRW_PER_G ì‹œì„¸ ì¡°íšŒ
2. í™˜ìœ¨ ì ìš©í•˜ì—¬ total_amount_krw ê³„ì‚°
3. cms_receipt_pricing_snapshot UPSERT
4. í™˜ìœ¨ ë©”íƒ€ì •ë³´ ì €ì¥ (fx_tick_id, fx_rate, etc.)

### 3. cms_fn_apply_receipt_pricing_snapshot_v1
**íŒŒì¼**: 20260201004000_cms_0266_receipt_pricing_apply.sql (line 219-273)

**ëª©ì **: ì˜ìˆ˜ì¦ ê¸ˆì•¡ì„ ì—°ê²°ëœ ì¶œê³ ì— ë¹„ë¡€ ë°°ë¶„

**ë¡œì§**:
1. cms_receipt_pricing_snapshot ì¡°íšŒ
2. total_amount_krw í™•ì¸ (ì €ì¥ë˜ì–´ ìˆì–´ì•¼ í•¨)
3. cms_receipt_usageì—ì„œ ì—°ê²°ëœ ì¶œê³  ì¡°íšŒ (SHIPMENT_HEADER/SHIPMENT_LINE)
4. ê° ì¶œê³ ì˜ basis_cost_krw (ë˜ëŠ” sell_krw) í•©ê³„ ê³„ì‚°
5. ë¹„ë¡€ ë°°ë¶„í•˜ì—¬ ê° ì¶œê³ ì— ì›ê°€ ì ìš©:
   - cms_fn_apply_purchase_cost_to_shipment_v1 í˜¸ì¶œ
   - mode='RECEIPT', receipt_id ì „ë‹¬
6. cms_receipt_usageì— allocated_amount_krw ì €ì¥
7. cms_receipt_pricing_snapshotì— allocation_json ì €ì¥

### 4. cms_fn_apply_purchase_cost_to_shipment_v1
**íŒŒì¼**: 20260129225200_cms_0242_receipt_cost_rpcs.sql (line 89-320)

**ëª©ì **: ì¶œê³  ë¼ì¸ë³„ êµ¬ë§¤ ì›ê°€ ì ìš©

**ëª¨ë“œë³„ ë™ì‘**:
- **PROVISIONAL**: master_prov (ë§ˆìŠ¤í„° ì„ì‹œì›ê°€) ì‚¬ìš©
- **RECEIPT**: input_unit_cost ì‚¬ìš© (ì˜ìˆ˜ì¦ ë°°ë¶„ì•¡), status='ACTUAL'
- **MANUAL**: ì‚¬ìš©ì ì…ë ¥ unit_cost ì‚¬ìš©, status='ACTUAL'

**ì—…ë°ì´íŠ¸ ì»¬ëŸ¼**:
- purchase_unit_cost_krw
- purchase_total_cost_krw (= unit_cost Ã— qty)
- purchase_cost_status ('PROVISIONAL' | 'ACTUAL')
- purchase_cost_source ('MASTER' | 'RECEIPT' | 'MANUAL')
- purchase_receipt_id (RECEIPT ëª¨ë“œì¼ ë•Œë§Œ)

---

## ğŸ–¥ï¸ í”„ë¡ íŠ¸ì—”ë“œ êµ¬í˜„

### íŒŒì¼: web/src/app/(app)/purchase_cost_worklist/page.tsx

**ì£¼ìš” ê¸°ëŠ¥**:

1. **ì˜ìˆ˜ì¦ ëª©ë¡ ì¡°íšŒ**
   - API: `/api/purchase-cost-worklist`
   - View: cms_v_receipt_inbox_open_v1
   - í•„í„°: ALL | NEED_INPUT | NEED_APPLY | APPLIED

2. **ì˜ìˆ˜ì¦ ê°’ ì €ì¥ (Save)**
   - RPC: cms_fn_upsert_receipt_pricing_snapshot_v1
   - ì…ë ¥: currency_code, total_amount, weight_g, labor_basic, labor_other

3. **ì›ê°€ ì ìš© (Apply)**
   - RPC: cms_fn_apply_receipt_pricing_snapshot_v1
   - ì„ í–‰ì¡°ê±´: linked_shipment_cnt > 0 (ì—°ê²°ëœ ì¶œê³  í•„ìš”)
   - í”„ë¡œì„¸ìŠ¤: ì €ì¥ â†’ ì ìš© (2ë‹¨ê³„)

4. **ë°°ë¶„ ë¯¸ë¦¬ë³´ê¸°**
   - Frontendì—ì„œ calcAllocations í•¨ìˆ˜ë¡œ ê³„ì‚°
   - ê¸°ì¤€: basis_cost_krw (ì¶œê³  ë¼ì¸ë³„ ë‚´ë¶€ì›ê°€)
   - ë°©ë²•: progressive remainder allocation

5. **ì˜ìˆ˜ì¦ ì—…ë¡œë“œ**
   - API: `/api/receipt-upload`
   - íŒŒì¼ ì„ íƒ â†’ ì—…ë¡œë“œ â†’ ìë™ ì„ íƒ

6. **ì˜ìˆ˜ì¦ ë¯¸ë¦¬ë³´ê¸°**
   - API: `/api/receipt-preview?receipt_id=xxx`
   - ìƒˆ ì°½ì—ì„œ ì´ë¯¸ì§€/PDF í‘œì‹œ

### íŒŒì¼: web/src/app/api/purchase-cost-worklist/route.ts

**API ì—”ë“œí¬ì¸íŠ¸**: GET /api/purchase-cost-worklist?limit=250

**ë™ì‘**:
- Supabase Admin í´ë¼ì´ì–¸íŠ¸ë¡œ ì¡°íšŒ
- View: cms_v_receipt_inbox_open_v1
- ì •ë ¬: received_at DESC
- status <> 'ARCHIVED' í•„í„°

---

## ğŸ“ˆ View ì •ì˜

### cms_v_receipt_inbox_open_v1
**íŒŒì¼**: 20260201004000_cms_0266_receipt_pricing_apply.sql (line 476-567)

**êµ¬ì¡°**:
```sql
WITH linked_sh AS (
  -- cms_receipt_usageì—ì„œ SHIPMENT_HEADER/LINE ì—°ê²° ì¡°íšŒ
  -- entity_typeì— ë”°ë¼ shipment_id ì¶”ì¶œ
),
ship_rows AS (
  -- ì—°ê²°ëœ ì¶œê³  ìƒì„¸ ì •ë³´
  -- basis_cost_krw: ì¶œê³  ë¼ì¸ ì´ ë‚´ë¶€ì›ê°€
  -- line_cnt: ë¼ì¸ ìˆ˜
),
ship_agg AS (
  -- receipt_id ê¸°ì¤€ ì§‘ê³„
  -- linked_shipment_cnt: ì—°ê²°ëœ ì¶œê³  ìˆ˜
  -- linked_basis_cost_krw: ì´ basis
  -- linked_shipments: JSONB ë°°ì—´
)
SELECT
  r.*,  -- cms_receipt_inbox ì»¬ëŸ¼ë“¤
  vp.name as vendor_name,
  s.*,  -- cms_receipt_pricing_snapshot ì»¬ëŸ¼ë“¤
  a.linked_shipment_cnt,
  a.linked_basis_cost_krw,
  a.linked_shipments
FROM cms_receipt_inbox r
LEFT JOIN cms_party vp ON r.vendor_party_id = vp.party_id
LEFT JOIN cms_receipt_pricing_snapshot s ON s.receipt_id = r.receipt_id
LEFT JOIN ship_agg a ON a.receipt_id = r.receipt_id
WHERE r.status <> 'ARCHIVED';
```

---

## âœ… ê¸°ëŠ¥ ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 1. ì˜ìˆ˜ì¦ ì—…ë¡œë“œ
- [x] íŒŒì¼ ì—…ë¡œë“œ API ì‘ë™ (/api/receipt-upload)
- [x] ocr_docs ë²„í‚·ì— ì €ì¥
- [x] cms_receipt_inboxì— INSERT
- [x] sha256 ì¤‘ë³µ ì²´í¬

### 2. ì¶œê³ -ì˜ìˆ˜ì¦ ì—°ê²°
- [x] shipments í˜ì´ì§€ì—ì„œ ì˜ìˆ˜ì¦ ì„ íƒ
- [x] cms_receipt_usageì— INSERT (SHIPMENT_HEADER)
- [x] correlation_id ìƒì„± ë° ì €ì¥

### 3. ì›ê°€ë§ˆê° ì‘ì—…ëŒ€
- [x] ì˜ìˆ˜ì¦ ëª©ë¡ ì¡°íšŒ (/api/purchase-cost-worklist)
- [x] í•„í„°ë§ (NEED_INPUT | NEED_APPLY | APPLIED)
- [x] ê¸ˆì•¡ ì…ë ¥ ë° ì €ì¥ (KRW/CNY)
- [x] CNY í™˜ìœ¨ ìë™ ì¡°íšŒ (SILVER_CN_KRW_PER_G)
- [x] ì›ê°€ ì ìš© (ë¹„ë¡€ ë°°ë¶„)
- [x] ë°°ë¶„ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°

### 4. ì›ê°€ ë°°ë¶„ ë¡œì§
- [x] Basis: total_amount_cost_krw (ë˜ëŠ” sell_krw)
- [x] ì¶œê³ ë³„ ë¹„ë¡€ ê³„ì‚°
- [x] ë¼ì¸ë³„ ë¹„ë¡€ ê³„ì‚°
- [x] remainder allocation (í•©ê³„ ì •í™•ì„±)
- [x] cms_shipment_line.purchase_* ì»¬ëŸ¼ ì—…ë°ì´íŠ¸

### 5. ì´ë ¥ ì¶”ì 
- [x] cms_receipt_usage.allocation_method = 'BASIS_COST'
- [x] cms_receipt_usage.allocated_amount_krw ì €ì¥
- [x] cms_receipt_pricing_snapshot.allocation_json ì €ì¥
- [x] purchase_cost_trace JSONBì— ì´ë ¥ ëˆ„ì 

---

## ğŸ” ë°ì´í„° ê²€ì¦ ì¿¼ë¦¬

```sql
-- 1. ìµœê·¼ ì›ê°€ ì ìš© ë‚´ì—­ í™•ì¸
SELECT 
  r.receipt_id,
  r.file_path,
  s.total_amount_krw,
  s.applied_at,
  a.linked_shipment_cnt,
  a.linked_basis_cost_krw
FROM cms_receipt_inbox r
JOIN cms_receipt_pricing_snapshot s ON r.receipt_id = s.receipt_id
LEFT JOIN (
  SELECT receipt_id, 
         COUNT(*) as linked_shipment_cnt,
         SUM(allocated_amount_krw) as linked_basis_cost_krw
  FROM cms_receipt_usage 
  WHERE entity_type = 'SHIPMENT_HEADER'
  GROUP BY receipt_id
) a ON r.receipt_id = a.receipt_id
WHERE s.applied_at IS NOT NULL
ORDER BY s.applied_at DESC
LIMIT 10;

-- 2. íŠ¹ì • ì˜ìˆ˜ì¦ì˜ ë°°ë¶„ ìƒì„¸
SELECT * FROM get_receipt_links('RECEIPT_UUID');

-- 3. íŠ¹ì • ì¶œê³ ì˜ ì›ê°€ ì ìš© ë‚´ì—­
SELECT 
  sl.shipment_line_id,
  sl.model_name,
  sl.purchase_unit_cost_krw,
  sl.purchase_total_cost_krw,
  sl.purchase_cost_status,
  sl.purchase_cost_source,
  sl.purchase_receipt_id
FROM cms_shipment_line sl
WHERE sl.shipment_id = 'SHIPMENT_UUID';

-- 4. ë¯¸ì ìš© ì˜ìˆ˜ì¦ ëª©ë¡ (ì›ê°€ë§ˆê° ëŒ€ìƒ)
SELECT 
  r.receipt_id,
  r.file_path,
  r.received_at,
  a.linked_shipment_cnt
FROM cms_receipt_inbox r
LEFT JOIN cms_receipt_pricing_snapshot s ON r.receipt_id = s.receipt_id
LEFT JOIN (
  SELECT receipt_id, COUNT(*) as linked_shipment_cnt
  FROM cms_receipt_usage
  WHERE entity_type = 'SHIPMENT_HEADER'
  GROUP BY receipt_id
) a ON r.receipt_id = a.receipt_id
WHERE r.status = 'LINKED'
  AND (s.applied_at IS NULL OR a.linked_shipment_cnt > 0)
ORDER BY r.received_at DESC;
```

---

## ğŸ“ ê²°ë¡ 

**ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ëŠ” ì™„ì „íˆ ì‘ë™í•˜ëŠ” ê¸°ëŠ¥ì…ë‹ˆë‹¤.**

**í•µì‹¬ íë¦„**:
1. ì˜ìˆ˜ì¦ ì—…ë¡œë“œ â†’ `cms_receipt_inbox` (ocr_docs ë²„í‚·)
2. ì¶œê³ ì—ì„œ ì˜ìˆ˜ì¦ ì„ íƒ â†’ `cms_receipt_usage` (SHIPMENT_HEADER ì—°ê²°)
3. ì›ê°€ë§ˆê° ì‘ì—…ëŒ€ì—ì„œ ê¸ˆì•¡ ì…ë ¥ â†’ `cms_receipt_pricing_snapshot`
4. ì›ê°€ ì ìš© â†’ ì¶œê³  ë¼ì¸ë³„ ë¹„ë¡€ ë°°ë¶„ â†’ `cms_shipment_line.purchase_*`

**ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ ì •ìƒ ì‘ë™í•˜ë©°, ë°ì´í„° ë¬´ê²°ì„±ë„ ë³´ì¥ë©ë‹ˆë‹¤.**
