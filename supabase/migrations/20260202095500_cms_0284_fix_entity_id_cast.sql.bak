-- ==============================================================================
-- ğŸ” ì˜ìˆ˜ì¦-ì—”í‹°í‹° ë§í¬ ì¡°íšŒ SQL (íƒ€ì… ìºìŠ¤íŒ… ë¬¸ì œ í•´ê²°)
-- ==============================================================================
-- ë¬¸ì œ: cms_receipt_usage.entity_idëŠ” TEXT, cms_shipment_header.shipment_idëŠ” UUID
-- í•´ê²°: TEXTë¥¼ UUIDë¡œ CAST (entity_id::uuid)
-- ==============================================================================

-- 1ï¸âƒ£ SHIPMENT_HEADER (ì¶œê³ ) ë§í¬ ì¡°íšŒ
SELECT 
  u.usage_id,
  u.receipt_id,
  i.file_path as ì˜ìˆ˜ì¦íŒŒì¼,
  u.entity_type,
  u.entity_id,
  h.shipment_id,
  h.shipment_no as ì¶œê³ ë²ˆí˜¸,
  h.status as ì¶œê³ ìƒíƒœ,
  h.confirmed_at,
  u.created_at as ì—°ê²°ì‹œê°„,
  u.note
FROM cms_receipt_usage u
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
LEFT JOIN cms_shipment_header h ON u.entity_id::uuid = h.shipment_id  -- ğŸ”¥ TEXT â†’ UUID CAST
WHERE u.entity_type = 'SHIPMENT_HEADER'
ORDER BY u.created_at DESC
LIMIT 10;

-- 2ï¸âƒ£ SHIPMENT_LINE (ì¶œê³ ë¼ì¸) ë§í¬ ì¡°íšŒ  
SELECT 
  u.usage_id,
  u.receipt_id,
  i.file_path,
  u.entity_type,
  u.entity_id,
  sl.shipment_line_id,
  sl.shipment_id,
  sl.model_name,
  sl.total_amount_sell_krw,
  h.shipment_no,
  u.created_at
FROM cms_receipt_usage u
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
LEFT JOIN cms_shipment_line sl ON u.entity_id::uuid = sl.shipment_line_id  -- ğŸ”¥ TEXT â†’ UUID CAST
LEFT JOIN cms_shipment_header h ON sl.shipment_id = h.shipment_id
WHERE u.entity_type = 'SHIPMENT_LINE'
ORDER BY u.created_at DESC
LIMIT 10;

-- 3ï¸âƒ£ INVENTORY_MOVE_HEADER (ì¬ê³ ì´ë™) ë§í¬ ì¡°íšŒ
SELECT 
  u.usage_id,
  u.receipt_id,
  i.file_path,
  u.entity_type,
  u.entity_id,
  im.move_id,
  im.move_no,
  im.status,
  im.occurred_at,
  u.created_at
FROM cms_receipt_usage u
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
LEFT JOIN cms_inventory_move_header im ON u.entity_id::uuid = im.move_id  -- ğŸ”¥ TEXT â†’ UUID CAST
WHERE u.entity_type = 'INVENTORY_MOVE_HEADER'
ORDER BY u.created_at DESC
LIMIT 10;

-- 4ï¸âƒ£ ëª¨ë“  ì—”í‹°í‹° íƒ€ì…ë³„ í†µê³„
SELECT 
  u.entity_type,
  COUNT(*) as ë§í¬ìˆ˜,
  COUNT(DISTINCT u.receipt_id) as unique_receipts,
  COUNT(DISTINCT u.entity_id) as unique_entities,
  MIN(u.created_at) as ìµœì´ˆì—°ê²°,
  MAX(u.created_at) as ìµœê·¼ì—°ê²°
FROM cms_receipt_usage u
GROUP BY u.entity_type
ORDER BY ë§í¬ìˆ˜ DESC;

-- 5ï¸âƒ£ íŠ¹ì • ì˜ìˆ˜ì¦ì˜ ëª¨ë“  ì—°ê²° ì¡°íšŒ
-- SELECT * FROM get_receipt_links('YOUR_RECEIPT_ID_HERE');

CREATE OR REPLACE FUNCTION get_receipt_links(p_receipt_id uuid)
RETURNS TABLE (
  usage_id uuid,
  receipt_id uuid,
  file_path text,
  entity_type text,
  entity_id text,
  linked_name text,
  linked_status text,
  created_at timestamptz
)
LANGUAGE sql
STABLE
AS $$
  -- SHIPMENT_HEADER links
  SELECT 
    u.usage_id,
    u.receipt_id,
    i.file_path::text,
    u.entity_type::text,
    u.entity_id::text,
    h.shipment_no::text as linked_name,
    h.status::text as linked_status,
    u.created_at
  FROM cms_receipt_usage u
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  LEFT JOIN cms_shipment_header h ON u.entity_id::uuid = h.shipment_id
  WHERE u.receipt_id = p_receipt_id
    AND u.entity_type = 'SHIPMENT_HEADER'
  
  UNION ALL
  
  -- SHIPMENT_LINE links
  SELECT 
    u.usage_id,
    u.receipt_id,
    i.file_path::text,
    u.entity_type::text,
    u.entity_id::text,
    sl.model_name::text as linked_name,
    NULL::text as linked_status,
    u.created_at
  FROM cms_receipt_usage u
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  LEFT JOIN cms_shipment_line sl ON u.entity_id::uuid = sl.shipment_line_id
  WHERE u.receipt_id = p_receipt_id
    AND u.entity_type = 'SHIPMENT_LINE'
  
  UNION ALL
  
  -- INVENTORY_MOVE_HEADER links
  SELECT 
    u.usage_id,
    u.receipt_id,
    i.file_path::text,
    u.entity_type::text,
    u.entity_id::text,
    im.move_no::text as linked_name,
    im.status::text as linked_status,
    u.created_at
  FROM cms_receipt_usage u
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  LEFT JOIN cms_inventory_move_header im ON u.entity_id::uuid = im.move_id
  WHERE u.receipt_id = p_receipt_id
    AND u.entity_type = 'INVENTORY_MOVE_HEADER'
  
  ORDER BY created_at DESC;
$$;

-- 6ï¸âƒ£ íŠ¹ì • ì¶œê³ ì˜ ì˜ìˆ˜ì¦ ë§í¬ ì¡°íšŒ (ìˆ˜ì • ë²„ì „)
-- SELECT * FROM get_shipment_receipts('YOUR_SHIPMENT_ID_HERE');

CREATE OR REPLACE FUNCTION get_shipment_receipts(p_shipment_id uuid)
RETURNS TABLE (
  shipment_id uuid,
  shipment_no text,
  receipt_id uuid,
  file_path text,
  file_bucket text,
  total_amount_krw numeric,
  link_type text,
  linked_at timestamptz
)
LANGUAGE sql
STABLE
AS $$
  -- SHIPMENT_HEADER ì—°ê²°
  SELECT 
    h.shipment_id,
    h.shipment_no::text,
    i.receipt_id,
    i.file_path::text,
    i.file_bucket::text,
    i.total_amount_krw,
    'SHIPMENT_HEADER'::text as link_type,
    u.created_at as linked_at
  FROM cms_shipment_header h
  LEFT JOIN cms_receipt_usage u ON u.entity_type = 'SHIPMENT_HEADER' 
    AND u.entity_id::uuid = h.shipment_id
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  WHERE h.shipment_id = p_shipment_id
  
  UNION ALL
  
  -- SHIPMENT_LINE ì—°ê²° (ë¼ì¸ë³„)
  SELECT 
    h.shipment_id,
    h.shipment_no::text,
    i.receipt_id,
    i.file_path::text,
    i.file_bucket::text,
    i.total_amount_krw,
    'SHIPMENT_LINE'::text as link_type,
    u.created_at as linked_at
  FROM cms_shipment_header h
  JOIN cms_shipment_line sl ON h.shipment_id = sl.shipment_id
  LEFT JOIN cms_receipt_usage u ON u.entity_type = 'SHIPMENT_LINE' 
    AND u.entity_id::uuid = sl.shipment_line_id
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  WHERE h.shipment_id = p_shipment_id
    AND i.receipt_id IS NOT NULL
  
  ORDER BY linked_at DESC;
$$;

-- ==============================================================================
-- ì‚¬ìš©ë²•:
-- 1. íŠ¹ì • ì¶œê³ ì˜ ì˜ìˆ˜ì¦: SELECT * FROM get_shipment_receipts('SHIPMENT_UUID');
-- 2. íŠ¹ì • ì˜ìˆ˜ì¦ì˜ ì—°ê²°: SELECT * FROM get_receipt_links('RECEIPT_UUID');
-- 3. SHIPMENT_HEADER ë§í¬: ì¿¼ë¦¬ 1 ì‹¤í–‰
-- 4. ì „ì²´ í†µê³„: ì¿¼ë¦¬ 4 ì‹¤í–‰
-- ==============================================================================
