-- ==============================================================================
-- ğŸ” ì˜ìˆ˜ì¦-ì¶œê³  ë§í¬ ê²€ì¦ SQL (Receipt-Shipment Linkage Verification)
-- ==============================================================================
-- ëª©ì : ì¶œê³  ê³¼ì •ì—ì„œ ì„ íƒëœ ì˜ìˆ˜ì¦ì´ í•´ë‹¹ ì¶œê³ ì™€ ì •í™•íˆ ë§í¬ë˜ëŠ”ì§€ í™•ì¸
-- ì‚¬ìš©ì²˜: ë¨¸ì‹ ëŸ¬ë‹/ë”¥ëŸ¬ë‹ í•™ìŠµ ë°ì´í„° ê²€ì¦
-- ==============================================================================

-- ë¨¼ì € í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ìƒì„± (ì˜ì¡´ì„± í•´ê²°)
create table if not exists cms_receipt_usage (
  usage_id uuid primary key default gen_random_uuid(),
  receipt_id uuid not null references cms_receipt_inbox(receipt_id) on delete cascade,
  entity_type text not null, -- 'SHIPMENT_HEADER' | 'SHIPMENT_LINE' | etc.
  entity_id text not null,   -- uuid as text for polymorphic reference
  note text,
  actor_person_id uuid,
  correlation_id uuid,
  created_at timestamptz not null default now()
);

create index if not exists idx_cms_receipt_usage_receipt on cms_receipt_usage(receipt_id);
create index if not exists idx_cms_receipt_usage_entity on cms_receipt_usage(entity_type, entity_id);

-- 1ï¸âƒ£ ìµœê·¼ ì¶œê³  ë‚´ì—­ ë° ì—°ê²°ëœ ì˜ìˆ˜ì¦ í™•ì¸
SELECT 
  'ìµœê·¼ ì¶œê³ -ì˜ìˆ˜ì¦ ë§í¬ í˜„í™©' as ê²€ì¦í•­ëª©,
  h.shipment_id,
  h.shipment_id::text as ì¶œê³ ë²ˆí˜¸,
  h.status,
  h.confirmed_at,
  h.customer_party_id,
  l.shipment_line_id,
  l.model_name,
  l.total_amount_sell_krw,
  l.total_amount_cost_krw,
  u.receipt_id as linked_receipt_id,
  i.file_bucket,
  i.file_path,
  i.total_amount_krw as receipt_total_amount,
  i.status as receipt_status,
  u.entity_type,
  u.entity_id,
  u.created_at as link_created_at
FROM cms_shipment_header h
LEFT JOIN cms_shipment_line l ON h.shipment_id = l.shipment_id
LEFT JOIN cms_receipt_usage u ON (
  (u.entity_type = 'SHIPMENT_HEADER' AND u.entity_id::uuid = h.shipment_id)
  OR 
  (u.entity_type = 'SHIPMENT_LINE' AND u.entity_id::uuid = l.shipment_line_id)
)
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
WHERE h.created_at >= NOW() - INTERVAL '7 days'
ORDER BY h.confirmed_at DESC NULLS LAST, h.created_at DESC
LIMIT 20;

-- 2ï¸âƒ£ ì¶œê³ ë³„ ì˜ìˆ˜ì¦ ì—°ê²° ìƒíƒœ ì§‘ê³„
SELECT 
  'ì¶œê³ -ì˜ìˆ˜ì¦ ì—°ê²° í†µê³„' as ê²€ì¦í•­ëª©,
  h.shipment_id,
  h.shipment_id::text as ì¶œê³ ë²ˆí˜¸,
  h.status,
  COUNT(DISTINCT u.receipt_id) as linked_receipt_count,
  STRING_AGG(DISTINCT i.file_path, ', ') as receipt_files,
  SUM(l.total_amount_sell_krw) as total_sell_krw,
  SUM(l.total_amount_cost_krw) as total_cost_krw,
  SUM(i.total_amount_krw) as receipt_total_krw,
  CASE 
    WHEN COUNT(u.receipt_id) > 0 THEN 'âœ… ì˜ìˆ˜ì¦ ì—°ê²°ë¨'
    ELSE 'âŒ ì˜ìˆ˜ì¦ ë¯¸ì—°ê²°'
  END as link_status
FROM cms_shipment_header h
LEFT JOIN cms_shipment_line l ON h.shipment_id = l.shipment_id
LEFT JOIN cms_receipt_usage u ON (
  u.entity_type = 'SHIPMENT_HEADER' 
  AND u.entity_id::uuid = h.shipment_id
)
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
WHERE h.created_at >= NOW() - INTERVAL '7 days'
GROUP BY h.shipment_id, h.status
ORDER BY h.shipment_id DESC
LIMIT 20;

-- 3ï¸âƒ£ íŠ¹ì • ì¶œê³ ì˜ ì˜ìˆ˜ì¦ ë§í¬ ì„¸ë¶€ ì •ë³´ (shipment_idë¡œ ì¡°íšŒ)
-- SELECT * FROM verify_shipment_receipt_link('YOUR_SHIPMENT_ID_HERE');

CREATE OR REPLACE FUNCTION verify_shipment_receipt_link(p_shipment_id uuid)
RETURNS TABLE (
  ê²€ì¦í•­ëª© text,
  shipment_id uuid,
  shipment_ref text,
  shipment_status text,
  receipt_id uuid,
  receipt_file_path text,
  receipt_file_bucket text,
  receipt_total_amount numeric,
  link_entity_type text,
  link_entity_id text,
  link_created_at timestamptz,
  verification_status text
)
LANGUAGE sql
STABLE
AS $$
  SELECT 
    'ì¶œê³ -ì˜ìˆ˜ì¦ ìƒì„¸ ê²€ì¦'::text as ê²€ì¦í•­ëª©,
    h.shipment_id,
    h.shipment_id::text as shipment_ref,
    h.status::text as shipment_status,
    i.receipt_id,
    i.file_path::text as receipt_file_path,
    i.file_bucket::text as receipt_file_bucket,
    i.total_amount_krw as receipt_total_amount,
    u.entity_type::text as link_entity_type,
    u.entity_id::text as link_entity_id,
    u.created_at as link_created_at,
    CASE 
      WHEN i.receipt_id IS NOT NULL AND i.file_path IS NOT NULL THEN 'âœ… ìœ íš¨í•œ ì˜ìˆ˜ì¦ ë§í¬'
      WHEN u.receipt_id IS NOT NULL AND i.receipt_id IS NULL THEN 'âŒ ë§í¬ëŠ” ìˆìœ¼ë‚˜ ì˜ìˆ˜ì¦ ì •ë³´ ì—†ìŒ (DB ë¶ˆì¼ì¹˜)'
      ELSE 'âš ï¸ ì˜ìˆ˜ì¦ ë¯¸ì—°ê²°'
    END::text as verification_status
  FROM cms_shipment_header h
  LEFT JOIN cms_receipt_usage u ON (
    u.entity_type = 'SHIPMENT_HEADER' 
    AND u.entity_id::uuid = h.shipment_id
  )
  LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
  WHERE h.shipment_id = p_shipment_id;
$$;

-- 4ï¸âƒ£ ì˜ìˆ˜ì¦ ì‚¬ìš©ì²˜ ì¶”ì  (receipt_idë¡œ ì—­ì¡°íšŒ)
-- SELECT * FROM trace_receipt_usage('YOUR_RECEIPT_ID_HERE');

CREATE OR REPLACE FUNCTION trace_receipt_usage(p_receipt_id uuid)
RETURNS TABLE (
  receipt_id uuid,
  file_path text,
  file_bucket text,
  total_amount_krw numeric,
  receipt_status text,
  linked_shipment_id uuid,
  linked_shipment_ref text,
  linked_shipment_status text,
  linked_shipment_confirmed_at timestamptz,
  entity_type text,
  entity_id text,
  link_created_at timestamptz,
  verification_result text
)
LANGUAGE sql
STABLE
AS $$
  SELECT 
    r.receipt_id,
    r.file_path::text,
    r.file_bucket::text,
    r.total_amount_krw,
    r.status::text as receipt_status,
    h.shipment_id as linked_shipment_id,
    h.shipment_id::text as linked_shipment_ref,
    h.status::text as linked_shipment_status,
    h.confirmed_at as linked_shipment_confirmed_at,
    u.entity_type::text,
    u.entity_id::text,
    u.created_at as link_created_at,
    CASE 
      WHEN h.shipment_id IS NOT NULL THEN 'âœ… ì¶œê³ ì™€ ì—°ê²°ë¨'
      ELSE 'âš ï¸ ì¶œê³  ë¯¸ì—°ê²°'
    END::text as verification_result
  FROM cms_receipt_inbox r
  LEFT JOIN cms_receipt_usage u ON r.receipt_id = u.receipt_id
  LEFT JOIN cms_shipment_header h ON (
    u.entity_type = 'SHIPMENT_HEADER' 
    AND u.entity_id::uuid = h.shipment_id
  )
  WHERE r.receipt_id = p_receipt_id
  ORDER BY u.created_at DESC;
$$;

-- 5ï¸âƒ£ ë§í¬ í’ˆì§ˆ ê²€ì¦ (ë¶ˆì¼ì¹˜ í•­ëª© ì‹ë³„)
SELECT 
  'ë§í¬ í’ˆì§ˆ ê²€ì¦' as ê²€ì¦í•­ëª©,
  u.receipt_id,
  u.entity_type,
  u.entity_id,
  u.created_at as link_created_at,
  CASE 
    -- SHIPMENT_HEADER íƒ€ì…ì¸ë° í•´ë‹¹ shipment_idê°€ ì—†ìŒ
    WHEN u.entity_type = 'SHIPMENT_HEADER' AND h.shipment_id IS NULL 
      THEN 'âŒ ì˜¤ë¥˜: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¶œê³ ì— ë§í¬'
    -- SHIPMENT_LINE íƒ€ì…ì¸ë° í•´ë‹¹ line_idê°€ ì—†ìŒ  
    WHEN u.entity_type = 'SHIPMENT_LINE' AND sl.shipment_line_id IS NULL 
      THEN 'âŒ ì˜¤ë¥˜: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì¶œê³ ë¼ì¸ì— ë§í¬'
    -- ì˜ìˆ˜ì¦ì´ ì‚­ì œë¨
    WHEN i.receipt_id IS NULL 
      THEN 'âŒ ì˜¤ë¥˜: ì‚­ì œëœ ì˜ìˆ˜ì¦ì— ëŒ€í•œ ë§í¬'
    -- ì •ìƒ
    ELSE 'âœ… ì •ìƒ'
  END as quality_check
FROM cms_receipt_usage u
LEFT JOIN cms_shipment_header h ON u.entity_type = 'SHIPMENT_HEADER' AND u.entity_id::uuid = h.shipment_id
LEFT JOIN cms_shipment_line sl ON u.entity_type = 'SHIPMENT_LINE' AND u.entity_id::uuid = sl.shipment_line_id
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
WHERE u.created_at >= NOW() - INTERVAL '30 days'
  AND (
    (u.entity_type = 'SHIPMENT_HEADER' AND h.shipment_id IS NULL)
    OR (u.entity_type = 'SHIPMENT_LINE' AND sl.shipment_line_id IS NULL)
    OR i.receipt_id IS NULL
  )
ORDER BY u.created_at DESC;

-- 6ï¸âƒ£ ì¶œê³ -ì˜ìˆ˜ì¦ ë§¤í•‘ í…Œì´ë¸” êµ¬ì¡° í™•ì¸
SELECT 
  'í…Œì´ë¸” êµ¬ì¡° ê²€ì¦' as ê²€ì¦í•­ëª©,
  'cms_receipt_usage' as table_name,
  column_name,
  data_type,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'cms_receipt_usage'
  AND table_schema = 'public'
ORDER BY ordinal_position;

-- 7ï¸âƒ£ ë°ì´í„° ë¬´ê²°ì„± ê²€ì¦ ê²°ê³¼ ìš”ì•½
SELECT 
  'ë¬´ê²°ì„± ê²€ì¦ ìš”ì•½' as ê²€ì¦í•­ëª©,
  COUNT(*) as total_links,
  COUNT(DISTINCT u.receipt_id) as unique_receipts,
  COUNT(DISTINCT CASE WHEN u.entity_type = 'SHIPMENT_HEADER' THEN u.entity_id END) as unique_shipments,
  COUNT(CASE WHEN i.receipt_id IS NULL THEN 1 END) as orphaned_links,
  COUNT(CASE WHEN u.entity_type = 'SHIPMENT_HEADER' AND h.shipment_id IS NULL THEN 1 END) as invalid_shipment_links,
  COUNT(CASE WHEN u.entity_type = 'SHIPMENT_LINE' AND sl.shipment_line_id IS NULL THEN 1 END) as invalid_line_links
FROM cms_receipt_usage u
LEFT JOIN cms_receipt_inbox i ON u.receipt_id = i.receipt_id
LEFT JOIN cms_shipment_header h ON u.entity_type = 'SHIPMENT_HEADER' AND u.entity_id::uuid = h.shipment_id
LEFT JOIN cms_shipment_line sl ON u.entity_type = 'SHIPMENT_LINE' AND u.entity_id::uuid = sl.shipment_line_id;

-- ==============================================================================
-- ì‚¬ìš©ë²•:
-- 1. ìµœê·¼ ì¶œê³ -ì˜ìˆ˜ì¦ ë§í¬ í™•ì¸: ì¿¼ë¦¬ 1, 2 ì‹¤í–‰
-- 2. íŠ¹ì • ì¶œê³  ê²€ì¦: SELECT * FROM verify_shipment_receipt_link('SHIPMENT_UUID');
-- 3. íŠ¹ì • ì˜ìˆ˜ì¦ ì¶”ì : SELECT * FROM trace_receipt_usage('RECEIPT_UUID');
-- 4. í’ˆì§ˆ ê²€ì¦: ì¿¼ë¦¬ 5, 6, 7 ì‹¤í–‰
-- ==============================================================================
