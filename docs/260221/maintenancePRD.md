# PRD: CMS 보안/성능/안정성 개선 (업무 파이프라인 로직 불변)

- 버전: v1.1 (Pipeline-safe)
- 작성일: 2026-02-21 (KST)
- 범위: Supabase(Postgres/RLS/Storage) + Next.js App Router(API Routes/React Query)
- 핵심 원칙:
  - **주문 → 공장발주 → 영수증/매칭 → 출고대기 → 출고확정 → 미수 → 결제**
    단계의 **업무 로직(상태 전이/계산/생성 규칙)을 변경하지 않는다.**
  - 변경은 “접근 제어(권한)”, “조회 성능”, “파일 접근 안전성”, “진단/UX”에 한정한다.
  - 위험도가 큰 변경(업로드 플로우)은 **하위호환 + 점진 롤아웃**을 기본으로 한다.

---

## 1) 목표 (Goals)

### 1.1 보안
- `anon`(미로그인)에서 민감 데이터 조회 및 업무 RPC 실행을 차단
- Storage 파일 접근은 **DB 레코드 기반(예: receipt_id)** 으로만 허용 (bucket/path 직접 입력 차단)
- Service Role은 서버에서만 사용하며, 입력 검증/권한 검증 필수

### 1.2 성능
- 고객 목록/최근 출고 모델/정합성 검사/마켓틱 조회에서
  - 오버패칭 제거
  - N+1 제거
  - 병렬화 및 캐싱 적용

### 1.3 안정성
- 프리뷰/다운로드에서 서버 메모리 적재 제거
- 업로드 동시성 위험 완화 (하위호환 유지)

---

## 2) 비목표 (Non-Goals)
- 출고확정/미수생성/결제처리 등 **DB 함수/트리거 로직 수정 금지**
- 주문/공장발주/영수증 매칭 규칙 변경 금지
- UI 전면 리디자인 제외

---

## 3) 변경 영향도 요약 (Pipeline Impact Map)

| 항목 | 파이프라인 로직 영향 | 변경 성격 |
|---|---|---|
| P0-1 anon 권한 정리 | **없음(로직 불변)** | 권한/정책/GRANT 조정 |
| P0-3 Storage API 입력 제한 | **업무 규칙 영향 없음** | 파일 접근 경로만 변경 |
| P1-7 프리뷰/업로드 메모리 개선 | **업무 규칙 영향 없음** | 전송/프리뷰 방식 개선(하위호환) |
| P1-1 고객 목록 최적화 | 없음 | 조회 최적화 |
| P1-2 shipped-models 최적화 | 없음 | 조회 최적화 |
| P1-3 check-consistency 개선 | 없음(진단용) | 진단 API 성능/버그 수정 |
| P1-4 market-ticks 병렬/캐시 | 없음 | 성능 개선 |
| P1-5 queryKey/로그 개선 | 없음 | 성능/운영 개선 |
| P1-6 검색 디바운스(1글자 포함) | 없음 | UX/부하 개선 |

---

## 4) 요구사항 상세

# A. P0-1 Supabase `anon` 권한 정리 (Pipeline-safe)

## A1. 문제
마이그레이션에 `anon` 대상 SELECT policy / EXECUTE GRANT가 존재하여
비로그인 상태에서도 민감 데이터 조회 및 업무 RPC 호출 가능.

## A2. 요구사항
- [ ] **업무 변경 가능(mutating) RPC**는 `anon`에서 실행 불가
- [ ] 민감 테이블/뷰(AR, Party, Shipment 등) `anon` 조회 불가
- [ ] 로그인 사용자의 기존 기능은 유지되도록 필요한 권한은 `authenticated` 또는 server(service_role)에 부여
- [ ] CI에서 `anon` 오픈 재발 방지 가드 추가(allowlist 제외)

## A3. 구현 가이드 (로직 불변)
- DB 함수/트리거 로직은 수정하지 않는다.
- 오직:
  - `REVOKE ... FROM anon`
  - `DROP POLICY ... TO anon`
  - (필요 시) 동일 권한을 `authenticated`로 부여
- mutating 함수는:
  - 앱에서 **로그인 세션(authenticated JWT)** 으로 호출되거나
  - 서버 API에서 **service_role**로 호출되도록 정리

## A4. 수용 기준
- [ ] anon 토큰으로 민감 SELECT / mutating RPC 실행 실패
- [ ] authenticated 사용자로 기존 화면/동작 정상(회귀 없음)

---

# B. P0-3 Storage 접근 API: bucket/path 직접 입력 차단 (Pipeline-safe)

## B1. 문제
현재 API가 bucket/path를 사용자 입력으로 받고 service_role로 signed URL 발급/다운로드하여 권한 우회 가능.

## B2. 요구사항
- [ ] API는 기본 입력을 `receipt_id` 중심으로 변경
- [ ] 서버는 `receipt_id`로 DB에서 bucket/path 조회 후 signed URL 발급
- [ ] 권한 검증: 현재 사용자(auth.uid())가 해당 receipt에 접근 가능해야 함
- [ ] 에러 응답에 path 노출 금지

## B3. 하위호환 전략(중요)
- 1차 배포에서 기존 호출이 남아있을 수 있으므로:
  - [ ] 기존 `bucket/path` 파라미터가 오더라도 **즉시 접근 허용하지 않고**
    - allowlist bucket + path prefix 검증
    - (가능하면) receipt_id 매칭 검증
  - [ ] 점진적으로 프론트에서 `receipt_id` 방식으로 전환

## B4. 수용 기준
- [ ] 임의 bucket/path로 파일 접근 불가
- [ ] 권한 없는 receipt 접근 403
- [ ] 기존 기능(프리뷰/다운로드) UX 유지

---

# C. P1-7 프리뷰/업로드 메모리 적재 제거 (Pipeline-safe)

## C1. 문제
프리뷰/업로드에서 arrayBuffer 기반 메모리 적재 → 동시성에서 OOM/지연 위험.

## C2. 요구사항
### 프리뷰/다운로드
- [ ] 서버가 파일 바이트를 메모리에 올리지 않음
- [ ] signed URL 생성 후 redirect 또는 URL 반환

### 업로드 (하위호환 유지)
- [ ] 1차: 기존 업로드 플로우 유지 + 크기/타입 제한 강화 + 안정성(동시성) 개선
- [ ] 2차(옵션): 서명 업로드(Direct-to-Storage) 신규 엔드포인트 추가 후 점진 전환
- [ ] 업로드 결과로 생성되는 DB 레코드/매칭 로직은 변경하지 않음

## C3. 수용 기준
- [ ] 프리뷰/다운로드 시 서버 메모리 급증 없음
- [ ] 업로드 동시 요청에서 안정성 개선 (오류율/타임아웃 감소)

---

# D. P1-1 고객 목록 조회 최적화 (Read-only)

## D1. 문제
고객 목록을 전부 로딩 후 클라이언트 정렬/페이징.

## D2. 요구사항
- [ ] DB에서 정렬/페이징 처리 (limit/offset 또는 cursor)
- [ ] 결과는 페이지 단위(예: 50개)
- [ ] count는 옵션화(필요 시만)

## D3. 수용 기준
- [ ] 고객 10k에서도 1페이지 응답 안정
- [ ] payload가 페이지 크기 수준

---

# E. P1-2 /api/shipped-models 최적화 (Read-only)

## E1. 요구사항
- [ ] 항상 50개 이하 반환
- [ ] DB에서 distinct/grouping 처리
- [ ] 최근 출고 기준 정렬(가능하면 last_shipped_at 포함)

---

# F. P1-3 /api/check-consistency N+1 제거 + 버그 수정 (Diagnostic only)

## F1. 원칙
- 진단용이며, 파이프라인 업무 로직/데이터를 변경하지 않는다(조회만).
- N+1 제거, 잘못된 ID 매핑 버그 수정.

## F2. 수용 기준
- [ ] 루프 내 DB 호출 없음
- [ ] 검사 결과 신뢰도 개선

---

# G. P1-4 /api/market-ticks 병렬화 + 캐싱 (Read-only)

## G1. 요구사항
- [ ] Promise.all 병렬화
- [ ] 짧은 캐싱(예: 10초) 도입
- [ ] 응답 값은 기존과 동일(순서/필드 포함)

---

# H. P1-5 shipments_main queryKey/로그 개선 (UI/운영)

## H1. 요구사항
- [ ] 큰 배열을 queryKey에 직접 넣지 않음(해시화)
- [ ] 운영 로그 최소화(PII/상세 데이터 출력 금지)

---

# I. P1-6 검색 UX 개선 (1글자 포함 검색 유지)

## I1. 요구사항(사용자 요구 반영)
- [ ] 최소 1글자부터 검색
- [ ] “해당 글자 포함” 검색(ILIKE '%q%') 유지
- [ ] 디바운스(250~300ms)
- [ ] 결과 제한(예: 50) + 페이지네이션/더보기
- [ ] 캐싱(staleTime 예: 30초)

## I2. 수용 기준
- [ ] 네트워크 호출 수 감소(타이핑 폭주 방지)
- [ ] 1글자 포함 검색 동작 유지

---

## 5) 테스트/검증 (Pipeline 회귀 방지 중심)

### 5.1 파이프라인 회귀 테스트(필수)
- [ ] 주문 생성 → 공장발주 → 영수증 업로드/프리뷰 → 매칭 → 출고대기 → 출고확정 → 미수 생성 → 결제 처리
  - **기존과 동일한 상태 전이/값** 확인
- [ ] 단, 이번 개선은 로직을 바꾸지 않으므로 “성공/실패 조건”이 기존과 동일해야 함

### 5.2 보안 테스트
- [ ] anon으로 민감 조회/업무 RPC 실패
- [ ] Storage 임의 path 접근 실패

### 5.3 성능 테스트
- [ ] 고객 10k/출고라인 대량에서도 응답 안정

---

## 6) 롤아웃 전략 (위험 최소화)

- PR#1 (P0): anon 권한 정리 + CI 가드 + 회귀 테스트
- PR#2 (P0/P1): receipt-file/preview 보안 강화(하위호환 포함) + redirect 프리뷰
- PR#3 (P1): 고객 목록/검색/shipped-models/market-ticks 최적화
- PR#4 (P1): check-consistency 개선 + shipments_main queryKey/로그 정리
- 업로드 서명 방식은 PR#5로 분리(옵션/플래그 기반), 기존 방식 유지하며 점진 전환

---