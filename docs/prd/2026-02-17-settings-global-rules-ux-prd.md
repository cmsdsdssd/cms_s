# Settings 글로벌 룰 개편 PRD (Range 기반 + 확장형 UX)

작성일: 2026-02-17  
작성자: OpenCode

## 1. 배경과 문제

현재 `settings`의 글로벌 룰 화면은 다음 문제가 있습니다.

1. 입력 항목이 한 화면에 과밀하게 섞여 있어, 운영자가 어디를 먼저 봐야 하는지 어렵다.
2. 컴포넌트/스코프/적용단위 등의 기술적 옵션이 노출되어 비개발자 관점에서 혼란이 크다.
3. "원가 구간별 마진"을 빠르게 만들고 조정하는 사용 흐름(예: 1만원~2만원 구간 + 마진 설정)이 비효율적이다.
4. 향후 룰 항목이 늘어날 가능성에 비해 현재 화면 구조가 확장 친화적이지 않다.

## 2. 목표

### 비즈니스 목표
- 운영자가 **원가 Range 단위**로 마진 룰을 빠르게 생성/수정할 수 있게 한다.
- 설정 실수(잘못된 스코프/단위 선택)를 줄여 운영 안정성을 높인다.
- 룰 항목이 증가해도 같은 UX 패턴으로 수평 확장 가능하게 만든다.

### 제품 목표
- 기본공임 룰을 중심으로 한 **단순한 1차 화면** 제공.
- "1,000원 단위 드롭다운 + 직접 입력" 혼합 입력 지원.
- AR/v2처럼 좌우 정보 분리(입력 패널 + 목록/검증 패널)로 가독성 향상.

## 3. 비목표 (Out of Scope)

- 0603 엔진의 계산 로직 자체 변경(공식 변경)은 이번 범위에서 제외.
- 기존 룰 데이터 삭제/재정규화는 제외(호환 유지).
- 신규 컴포넌트 타입 추가(예: 완전히 새로운 룰 엔진 타입)는 제외.

## 4. 현재 상태(근거)

### 현재 UI
- 글로벌 룰 섹션: `web/src/app/(app)/settings/page.tsx:881`
- 룰 생성/수정 + 목록 + 테스트가 한 카드 내부에 혼합되어 밀집됨.

### 현재 API/제약
- 저장 API: `web/src/app/api/pricing-rules/route.ts`
- 테스트 API: `web/src/app/api/pricing-rule-pick/route.ts`
- 핵심 제약:
  - `BASE_LABOR`는 `PER_PIECE`만 허용 (`pricing-rules`:102~104, `pricing-rule-pick`:48~50)
  - `BASE_LABOR`는 `stone_role` 허용 안함 (`pricing-rules`:105~107, `pricing-rule-pick`:51~53)
  - `min_cost_krw >= 0`, `max_cost_krw >= min_cost_krw`

### 엔진 반영
- `BASE_LABOR` 룰 조회 후 판매공임에 합산:
  - `supabase/migrations/20260216090000_cms_0603_margin_engine_backend_sql_patch.sql:691`
  - `...:695`, `...:711`, `...:712`

## 5. 타겟 UX 원칙

1. **업무 언어 우선**: 기술 enum 노출 최소화, 한국어 라벨 중심.
2. **범위 편집 우선**: "원가 구간"과 "마진"을 1급 개체로 취급.
3. **확장 가능 레이아웃**: 룰 종류가 늘어도 탭/세그먼트로 확장 가능.
4. **안전한 기본값**: 기본공임(공장/개당) 고정 축을 기본으로 제공.

## 6. 정보구조(IA) 제안

## 6.1 3-룰 상단 세그먼트

상단 세그먼트(또는 탭):
- 기본공임
- 세팅
- 알공임

초기 릴리즈(v1)에서는 기본공임을 기본 활성 탭으로 시작.

## 6.2 화면 2-패널 구조 (AR/v2 감성)

- 좌측: **룰 편집 패널** (신규/수정, 빠른 Range 입력)
- 우측: **룰 목록/검증 패널** (구간표, 충돌 경고, 테스트)

모바일에서는 세로 스택으로 전환.

## 7. 핵심 기능 요구사항

## 7.1 Range 입력 UX (필수)

각 룰 행은 아래 필드를 가짐:
- 공장(선택: 전체/특정)
- 시작 원가(min)
- 종료 원가(max, 비우면 무한)
- 마진(원)
- 우선순위
- 활성 여부

### 1,000원 단위 드롭다운 + 직접입력
- `min/max/마진` 모두 아래 방식 지원:
  1. 퀵 드롭다운: 0, 1,000, 2,000 ... 100,000 (가변 상한)
  2. 직접 입력: 숫자 타이핑(자동 콤마 포맷)
- 포커스 아웃 시 정규화:
  - 숫자 아닌 값 제거
  - 음수 방지
  - `max < min`이면 즉시 에러 표시

## 7.2 Range 행 관리

- 행 추가 / 행 삭제 / 행 복제
- 일괄 +Δ 조정(현재 필터 대상)
- 정렬 기준 기본값: `min_cost asc`, 동률 시 `priority asc`

## 7.3 충돌/누락 가드

- 구간 겹침 경고(동일 공장+동일 룰타입 조건에서)
- 구간 공백 경고(선택 기능): 원가 대역 중 미정의 구간 존재 시 안내

## 7.4 테스트 패널

- 입력: 공장, 원가
- 출력: 선택 룰 ID, 적용 마진(원)
- 탭 컨텍스트에 따라 component/scope/apply_unit은 내부 고정 매핑

## 8. 룰타입별 매핑 정책 (초안)

각 탭은 내부적으로 아래 API 파라미터로 고정 매핑한다.

- 기본공임 탭
  - `component=BASE_LABOR`, `scope=FACTORY`, `apply_unit=PER_PIECE`, `stone_role=null`
- 세팅 탭
  - 기본안: `component=SETTING`, `scope=FACTORY`, `apply_unit=PER_PIECE`
- 알공임 탭
  - 기본안: `component=STONE`, `scope=FACTORY`, `apply_unit=PER_STONE`
  - stone_role은 v1에서는 숨기고 "전체 알공임"으로 시작, v1.1에서 고급옵션으로 확장

주의: 위 2~3번 탭 매핑은 현업 정책 확인 후 확정.

## 8.1 룰 모델 고정 원칙 (중요)

PRD/구현 모두 아래 API 필드에 1:1 매핑한다.

- `component`
- `scope`
- `apply_unit`
- `stone_role`
- `vendor_party_id`
- `min_cost_krw`
- `max_cost_krw`
- `markup_value_krw`
- `priority`
- `is_active`

별도 가상 타입(예: 프론트 전용 "특수 룰")은 만들지 않는다.

## 8.2 Range 의미 규칙 (중요)

정책을 명시적으로 고정한다.

1. 경계 포함 규칙: `min_cost_krw <= 원가 <= max_cost_krw`
2. `max_cost_krw`가 비어 있으면 "상한 없음"으로 해석
3. 동일 키(룰타입+공장) 내 **겹침 구간 저장 금지**
4. 동일 키 내 구간 공백은 허용하되 저장 시 경고 표시
5. 상한 없음 구간은 동일 키에서 1개만 허용, 정렬상 마지막 구간이어야 함

## 8.3 3-룰 UX 고정 원칙

"룰이 많아져서 복잡해지는 문제"를 막기 위해 UI를 고정한다.

- 탭은 3개 고정: 기본공임 / 세팅 / 알공임
- 각 탭은 기본 3행 슬롯 구조로 시작
  - 빈 슬롯은 "구간 추가" 카드로 표시
  - 3행 초과는 고급모드에서만 허용(Phase 2)
- 탭 헤더는 요약값을 항상 노출
  - 예: `3개 구간 · 겹침 0 · 상한없음 1`

## 9. 사용자 시나리오

### 시나리오 A: 기본공임 구간 2개 생성
1. 기본공임 탭 진입
2. 구간1: 10,000~20,000 / 마진 3,000 저장
3. 구간2: 20,001~40,000 / 마진 5,000 저장
4. 테스트 원가 15,000 입력 -> 마진 3,000 확인
5. 테스트 원가 30,000 입력 -> 마진 5,000 확인

### 시나리오 B: 대량 조정
1. 특정 공장 필터
2. +1,000 일괄 Δ 적용
3. 목록 즉시 갱신, 테스트로 반영 확인

## 10. API/데이터 요구사항

### 유지(호환)
- 기존 `cms_pricing_rule_v1` 스키마 재사용
- 기존 `/api/pricing-rules`, `/api/pricing-rule-pick` 재사용

### 추가(선택)
- 서버 검증 강화:
  - 동일 key(룰타입+공장) 내 겹치는 range 저장 차단 또는 warning 리턴
- 조회 API 확장:
  - 탭별/공장별 필터를 서버에서 지원하면 성능 및 단순성 개선

## 11. UX 카피 가이드 (한국어 기준)

- Component -> 룰종류
- Scope -> 적용대상
- ApplyUnit -> 적용단위
- Range -> 원가구간
- Markup -> 가산마진(원)
- Actions -> 작업
- picked_rule_id -> 적용 룰 ID

## 11.1 AR/v2 레퍼런스 적용 포인트

아래 화면 패턴을 참고해 글로벌룰 UX에 반영한다.

- `web/src/app/(app)/ar/v2/page.tsx`
  - 좌우 밀집 패널 + 상단 액션 + 안내 박스 구조
- `web/src/app/(app)/new_receipt_line_workbench/receipt-line-workbench.tsx`
  - 필터 접기/펼치기, 상태 중심 UX
- `web/src/app/(app)/workbench/[partyId]/_components/workbench-activity.tsx`
  - range 선택 칩 패턴

적용 원칙:

- 입력과 결과(목록/테스트)를 공간적으로 분리
- 기본은 요약 보기, 상세는 펼쳐서 편집
- 상태/경고를 숫자+텍스트로 한 번에 노출

## 12. 단계별 릴리즈 계획

### Phase 1 (빠른 개선)
- 기본공임 탭 단일화
- Range 입력 UX(드롭다운+직접입력)
- 목록 한글화 + 테스트 패널 단순화
- Range 의미 규칙(겹침 금지/공백 경고) 적용

### Phase 2
- 세팅/알공임 탭 추가
- 탭별 검증 룰/경고 강화

### Phase 3
- 고급옵션(알공임 stone_role 분해, 템플릿, CSV 일괄 업로드)

## 13. 수용 기준 (Acceptance Criteria)

1. 운영자는 3클릭 이내로 "원가 구간 + 마진" 행을 생성할 수 있다.
2. min/max/margin에 대해 1,000원 단위 선택과 직접입력이 모두 동작한다.
3. 저장 시 음수/역전 구간(`max < min`)은 차단된다.
4. 테스트 패널에서 공장+원가 입력 시 적용 마진이 즉시 확인된다.
5. 기본공임 탭에서 엔진 계산 결과가 기존 대비 일관되게 반영된다.
6. 동일 키(룰타입+공장)에서 구간 겹침 저장 시 차단된다.
7. 상한 없음 구간은 마지막 1개만 허용된다.
8. 화면 상단 요약에 `구간 수/겹침 수/상한없음 수`가 즉시 반영된다.

## 14. 측정 지표

- 룰 저장 완료까지 걸리는 평균 시간
- 저장 실패율(검증 에러)
- 룰 테스트 사용률
- 운영 문의(룰 위치/의미 관련) 감소율

## 15. 리스크 및 대응

- 리스크: 기존 데이터가 겹치는 range를 이미 포함할 수 있음
  - 대응: 초기에는 warning 표시, 추후 강제 차단으로 점진 전환
- 리스크: 탭 3개 확장 시 다시 복잡해질 가능성
  - 대응: 공통 RangeGrid 컴포넌트 + 고급옵션 접기 정책

## 16. 구현 파일 초안(참고)

- 변경(핵심): `web/src/app/(app)/settings/page.tsx`
- 유지 API: `web/src/app/api/pricing-rules/route.ts`
- 유지 테스트 API: `web/src/app/api/pricing-rule-pick/route.ts`
- 옵션(분리 리팩터):
  - `web/src/app/(app)/settings/_components/GlobalRuleTabs.tsx`
  - `web/src/app/(app)/settings/_components/RangeRuleEditor.tsx`
  - `web/src/app/(app)/settings/_components/RangeRuleTable.tsx`

---

본 PRD는 "구조/정책 합의" 문서이며, 다음 단계에서 이 문서를 기준으로 구현 계획(작업 단위/일정/검증 시나리오)을 작성한다.
